##
# File:    PubMedUtilsTests.py
# Author:  j. westbrook
# Date:    27-Apr-2019
# Version: 0.001
#
# Update:
##
"""
Test cases for individual and batch fetch of PubMed entries.

    @unittest.skipIf(condition, reason)
    @unittest.skipUnless(condition, reason)

"""

import logging
import os
import unittest

from rcsb.utils.citation.PubMedUtils import PubMedUtils
from rcsb.utils.io.MarshalUtil import MarshalUtil

HERE = os.path.abspath(os.path.dirname(__file__))
TOPDIR = os.path.dirname(os.path.dirname(os.path.dirname(HERE)))

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger()


class PubMedUtilsTests(unittest.TestCase):
    def setUp(self):
        self.__export = False
        self.__mU = MarshalUtil()
        self.__workPath = os.path.join(HERE, "test-output")
        #
        self.__pidList1 = ["21540484", "15192106", "17110339", "11294653", "21719702", "29519914", "18976664", "12493825", "24794573"]

        self.__pidList2 = [
            "27744351",
            "30413611",
            "10360352",
            "29234012",
            "30254335",
            "16041081",
            "8341712",
            "30746096",
            "27725182",
            "9817840",
            "23747973",
            "2716847",
            "30659147",
            "20866049",
            "26876147",
            "21397187",
            "23414845",
            "18077447",
            "30066404",
            "22891849",
            "11456486",
            "20934431",
            "22648417",
            "22006298",
            "22740694",
            "22516613",
            "11695891",
            "9000634",
            "28201607",
            "17588773",
            "23047679",
            "23370277",
            "23954514",
            "9546396",
            "15173586",
            "17237768",
            "8515466",
            "27466404",
            "23285112",
            "29593097",
            "11377203",
            "12445769",
            "17258768",
            "2356117",
            "11935353",
            "9300804",
            "3586021",
            "11420435",
            "25479443",
            "21685874",
            "16614214",
            "12079340",
            "10957635",
            "7630423",
            "19748341",
            "21402358",
            "18351739",
            "28306506",
            "17855371",
            "16455797",
            "1504238",
            "16618936",
            "24279727",
            "19000819",
            "21888914",
            "29950717",
            "14503859",
            "23615615",
            "9062194",
            "21738568",
            "8969301",
            "28691351",
            "29877794",
            "28291748",
            "15317976",
            "17937659",
            "27298375",
            "25484220",
            "27045007",
            "26517568",
            "17389404",
            "17937404",
            "20444688",
            "16970402",
            "23525461",
            "27452405",
            "9215631",
            "28035004",
            "23295485",
            "22632933",
            "22868762",
            "19478441",
            "19724118",
            "12446723",
            "18166458",
            "26878343",
            "15299440",
            "23376934",
            "28436492",
            "17643372",
            "9309217",
            "25581127",
            "28186120",
            "15726637",
            "16034420",
            "17185228",
            "21983341",
            "11738048",
            "22553781",
            "27302953",
            "12925788",
            "16298300",
            "27452405",
            "28955968",
            "20731394",
            "27670069",
            "25478842",
            "29372894",
            "26214367",
            "30872815",
            "18391214",
            "22026756",
            "12213964",
            "17546672",
            "17512409",
            "25766630",
            "24022486",
            "27150042",
            "19077538",
            "18772888",
            "9164465",
            "15477603",
            "11807262",
            "17690686",
            "11294653",
            "21719702",
            "21167174",
            "29519914",
            "19218457",
            "12228241",
            "8780507",
            "25522882",
            "29309127",
            "15476820",
            "27219477",
            "27762275",
            "29358376",
            "24469830",
            "24768818",
            "26020686",
            "15260491",
            "24260472",
            "23385460",
            "26774281",
            "18623065",
            "9000078",
            "18689676",
            "11849038",
            "12627956",
            "21410435",
            "28737762",
            "20004667",
            "18175328",
            "18951093",
            "23660647",
            "19801657",
            "18461940",
            "15514022",
            "21945529",
            "19622862",
            "17599355",
            "9374867",
            "10960481",
            "15857831",
            "8266098",
            "16444759",
            "12230560",
            "27977135",
            "11141052",
            "16386905",
            "16615916",
            "30552142",
            "10076005",
            "29309127",
            "9865942",
            "27805810",
            "15159593",
            "12560098",
            "29632366",
            "27238019",
            "27120112",
            "27499202",
            "24395783",
            "20669977",
            "29083550",
            "23540833",
            "30934718",
            "27299673",
            "26976576",
            "12962626",
            "27710931",
            "29293962",
            "29199952",
            "29109539",
            "10725379",
            "15895092",
            "1849423",
            "14502267",
            "25533949",
            "22073177",
            "22805786",
            "22266370",
            "23863937",
            "29414791",
            "25733891",
            "22266819",
            "19812032",
            "20852643",
            "18230722",
            "24880687",
            "20696396",
            "18347016",
            "16472751",
            "28436492",
            "9814710",
            "29372908",
            "22659321",
            "28320959",
            "27979997",
            "15326523",
            "23818958",
            "25463616",
            "18453697",
            "17045609",
            "19616009",
            "16330048",
            "10367892",
            "20419351",
            "17157249",
            "17242506",
            "15299887",
            "26015367",
            "15324813",
            "19927125",
            "23430740",
            "15823035",
            "17606921",
            "19385626",
            "7545077",
            "12207021",
            "10738204",
            "22411095",
            "28940468",
            "27942001",
            "29717023",
            "23485912",
            "15221026",
            "19143837",
            "17804402",
            "27210287",
            "21972967",
            "15328534",
            "21867916",
            "22421137",
            "18570875",
            "24292073",
            "21632537",
            "18062934",
            "2734296",
            "29658702",
            "25931264",
            "23474121",
            "11574463",
            "17714077",
            "28739908",
            "25326326",
            "26636256",
            "22078562",
            "18212128",
            "16341830",
            "11206077",
            "27571177",
            "27073009",
            "28008132",
            "26061247",
            "14729348",
            "24472022",
            "24130487",
            "22078566",
            "28661582",
            "15037077",
            "18252712",
            "9096235",
            "19712110",
            "19704023",
            "17329808",
            "30573650",
            "28057518",
            "19262666",
            "22957058",
            "24167270",
            "14761185",
            "20944746",
            "15084603",
            "18373353",
            "27470012",
            "25849387",
            "17473008",
            "20924370",
            "28436492",
            "17630786",
            "30950830",
            "10559988",
            "28436492",
            "26288844",
            "24101498",
            "22822203",
            "22098589",
            "22283712",
            "25673702",
            "30742897",
            "10198229",
            "19822742",
            "26936968",
            "22403005",
            "1656049",
            "1594574",
            "8515446",
            "23138692",
            "19037309",
            "24173033",
            "10617631",
            "29679384",
            "20421974",
            "17293595",
            "23041282",
            "16266687",
            "8289247",
            "19200624",
            "22868768",
            "27571029",
            "16008357",
            "27897163",
            "9712872",
            "27016741",
            "10438628",
            "28878138",
            "18799424",
            "28363957",
            "22691049",
            "22299652",
            "30912932",
            "9875849",
            "21650210",
            "28972138",
            "27210805",
            "25084393",
            "27738104",
            "12393860",
            "23261599",
            "8520473",
            "20398219",
            "25246523",
            "17826792",
            "29229824",
            "26258479",
            "15252033",
            "8378335",
            "24555072",
            "26833566",
            "24615888",
            "23868186",
            "8946850",
            "11237854",
            "19515814",
            "30503210",
            "18467126",
            "29095570",
            "28436492",
            "9041630",
            "22245970",
            "29899397",
            "26274608",
            "12077437",
            "18573100",
            "25392992",
            "28319136",
            "24578532",
            "26833702",
            "29897575",
            "29042532",
            "22988064",
            "20805881",
            "28729350",
            "30946901",
            "22522257",
            "24975648",
            "21310613",
            "26983786",
            "20339000",
            "26912459",
            "27210287",
            "30591568",
            "17925389",
            "14622596",
            "24027321",
            "24657930",
            "24904158",
            "27339134",
            "21477108",
            "29217579",
            "28514451",
            "16854060",
            "21812398",
            "25878106",
            "15178758",
            "11733066",
            "11014182",
            "9600906",
            "18974054",
            "18780816",
            "21248202",
            "24121504",
            "20124719",
            "20558186",
            "8663181",
            "30195326",
            "16188992",
            "27068646",
            "26249689",
            "27404588",
            "16700541",
            "30283132",
            "1942029",
            "21972967",
            "26155854",
            "12833155",
            "27664121",
            "19666719",
            "20541266",
            "18611220",
            "29768913",
            "12456667",
            "28042045",
            "26220180",
            "21378188",
            "21045295",
            "15563469",
            "11428899",
            "9761872",
            "19229296",
            "28989719",
            "21714539",
            "28584265",
            "20198658",
            "20179337",
            "26551522",
            "17445830",
            "8590022",
            "20090755",
            "22213444",
            "29588525",
            "26807544",
            "7881904",
            "28275738",
            "23072374",
            "23229556",
            "21505249",
            "30771275",
            "15719022",
            "8950276",
            "14749470",
            "17007609",
        ]

    def tearDown(self):
        pass

    def testFetchIds(self):
        """ Test individual entry fetch
        """
        try:
            fobj = PubMedUtils(saveText=True)
            for tId in self.__pidList1:
                idList = [tId]
                retD = fobj.fetchList(idList)
                self.assertGreaterEqual(len(retD), len(idList))
                #
                if retD and self.__export:
                    fobj.writeUnpXml(os.path.join(self.__workPath, tId + ".xml"))
                    self.__mU.doExport(os.path.join(self.__workPath, tId + ".json"), retD, format="json", indent=3)
                #
        except Exception as e:
            logger.exception("Failing with %s", str(e))
            self.fail()

    def testBatchFetch(self):
        """ Test batch pubmed entry fetch
        """
        try:
            fobj = PubMedUtils(saveText=False)
            idList = list(set(self.__pidList2))
            retD = fobj.fetchList(idList, maxChunkSize=350)
            self.assertGreaterEqual(len(retD), len(idList))
            if self.__export:
                self.__mU.doExport(os.path.join(self.__workPath, "pubmed-all.json"), retD, format="json", indent=3)
        except Exception as e:
            logger.exception("Failing with %s", str(e))
            self.fail()

    def __dumpEntries(self, retD):
        for (eId, eDict) in retD.items():
            logger.info("------ Entry id %s", eId)
            for k, v in eDict.items():
                logger.info("%-15s = %r", k, v)


def suiteFetchTests():
    suiteSelect = unittest.TestSuite()
    suiteSelect.addTest(PubMedUtilsTests("testFetchIds"))
    suiteSelect.addTest(PubMedUtilsTests("testBatchFetch"))
    return suiteSelect


def suiteJournalTests():
    suiteSelect = unittest.TestSuite()
    suiteSelect.addTest(PubMedUtilsTests("testGetJournalNames"))
    return suiteSelect


if __name__ == "__main__":
    #
    mySuite = suiteJournalTests()
    unittest.TextTestRunner(verbosity=2).run(mySuite)

    mySuite = suiteFetchTests()
    unittest.TextTestRunner(verbosity=2).run(mySuite)
#
